<!doctype html>
<html lang="th">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard</title>
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=11">
</head>

<body>
<div class="wrap">

  <!-- ================= TOPBAR ================= -->
  <div class="topbar">
    <div class="pill-title">
      <div class="icon">üìä</div>
      <div>
        <h1>Dashboard</h1>
        <div class="subtitle">
          ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß + Monitor + Map (auto refresh)
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn" href="/queues/">üìã Queue</a>
      <a class="btn" href="/queues/monitor/">ü©∫ Monitor</a>
      <a class="btn" href="/queues/map/">üó∫Ô∏è Map</a>
      <a class="btn" href="/accounts/login/">üö™ Logout</a>
    </div>
  </div>

  <!-- ================= GRID ================= -->
  <div class="grid">

    <!-- KPI -->
    <div class="card span4">
      <div class="kpi">
        <div>
          <div class="label">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ (WAITING)</div>
          <div class="val">{{ waiting_total }}</div>
        </div>
        <div class="pill"><span class="dot warn"></span>Live</div>
      </div>
      <div class="chips">
        <span class="chip"><span class="dot bad"></span>RED: {{ red_total }}</span>
        <span class="chip"><span class="dot warn"></span>YELLOW: {{ yellow_total }}</span>
        <span class="chip"><span class="dot good"></span>GREEN: {{ green_total }}</span>
      </div>
    </div>

    <div class="card span4">
      <div class="kpi">
        <div>
          <div class="label">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß (CALLED)</div>
          <div class="val">{{ called_total }}</div>
        </div>
        <div class="pill"><span class="dot good"></span>OK</div>
      </div>
      <div class="muted">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡∏ì {{ now }}</div>
    </div>

    <div class="card span4">
      <div class="kpi">
        <div>
          <div class="label">Online ‡∏à‡∏≤‡∏Å IoT</div>
          <div class="val" id="onlineCount">-</div>
        </div>
        <div class="pill"><span class="dot good"></span>60s</div>
      </div>
      <div class="muted" id="serverTime">loading...</div>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="card span12">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900;font-size:16px">
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Top 12) - FOLLOWUP
        </div>
        <div class="pill" id="lastRefresh">
          <span class="dot warn"></span>loading...
        </div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Visit</th>
              <th>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
              <th>Severity</th>
              <th>Online</th>
              <th>Vitals</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  let cachedItems = [];

  function vitalsText(v){
    if(!v) return "-";
    const bp = (v.sys_bp ?? "-") + "/" + (v.dia_bp ?? "-");
    return `BPM ${v.bpm ?? "-"} | O2 ${v.o2sat ?? "-"} | BP ${bp}`;
  }

  function levelClass(sev){
    if(sev==="RED") return "level-red";
    if(sev==="YELLOW") return "level-yellow";
    if(sev==="GREEN") return "level-green";
    return "";
  }

  async function setSeverity(visitId, sev){
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô cache ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏´‡πâ UI ‡πÄ‡∏£‡πá‡∏ß)
    const item = cachedItems.find(x=>x.visit_id===visitId);
    if(!item) return;
    item.severity = sev;
    render();

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á database
    try {
      const res = await fetch(`/queues/api/update-severity/${visitId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ severity: sev })
      });
      const data = await res.json();
      if(!data.ok){
        console.error('Failed to update severity:', data.error);
        // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server
        await loadSummary();
      }
    } catch(err) {
      console.error('Error updating severity:', err);
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server
      await loadSummary();
    }
  }

  function render(){
    const el = document.getElementById("rows");
    if(cachedItems.length===0){
      el.innerHTML = `<tr><td colspan="6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      return;
    }

    el.innerHTML = cachedItems.slice(0,12).map(x=>`
      <tr class="${levelClass(x.severity)}">
        <td>#${x.visit_id}</td>
        <td>${x.name ?? "-"}</td>
        <td>
          <span class="badge ${x.severity?.toLowerCase()}">${x.severity}</span>
        </td>
        <td>
          ${x.online
            ? `<span class="pill"><span class="dot good"></span>ONLINE</span>`
            : `<span class="pill"><span class="dot bad"></span>OFFLINE</span>`}
        </td>
        <td class="muted">${vitalsText(x.vitals)}</td>
        <td>
  <a class="btn" href="/queues/monitor/visit/${x.visit_id}/">‡∏î‡∏π</a>

  <button class="btn-red"
    onclick="setSeverity(${x.visit_id}, 'RED')">
    üî¥ RED
  </button>

  <button class="btn-yellow"
    onclick="setSeverity(${x.visit_id}, 'YELLOW')">
    üü° YELLOW
  </button>

  <button class="btn-green"
    onclick="setSeverity(${x.visit_id}, 'GREEN')">
    üü¢ GREEN
  </button>
</td>
      </tr>
    `).join("");
  }

  async function loadSummary(){
    const res = await fetch("/queues/monitor/api/latest/");
    const data = await res.json();
    cachedItems = data.rows || [];

    document.getElementById("onlineCount").textContent =
      `${cachedItems.filter(x=>x.online).length}/${cachedItems.length}`;
    document.getElementById("serverTime").textContent =
      "Server time: " + (data.server_time || "-");
    document.getElementById("lastRefresh").innerHTML =
      `<span class="dot good"></span>${new Date().toLocaleTimeString()}`;

    render();
  }

  loadSummary();
  setInterval(loadSummary, 5000);
</script>
</body>
</html>
